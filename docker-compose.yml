# ============================================================================
# FaceBlur Project - Docker Compose 설정 (개발 환경)
# ============================================================================
# 이 파일은 로컬 개발 환경에서 여러 서비스를 한 번에 실행합니다.
#
# 사용 방법:
#   시작: docker-compose up -d
#   중지: docker-compose down
#   로그: docker-compose logs -f [서비스명]
#   재빌드: docker-compose up -d --build
#
# 포함된 서비스:
#   - db: PostgreSQL 데이터베이스
#   - redis: Redis (캐시 & Celery 브로커)
#   - django: Django 웹 서버
#   - celery_worker: Celery 비동기 작업 워커 (Phase 4에서 활성화)
# ============================================================================

version: '3.9'

# ============================================================================
# 서비스 정의
# ============================================================================
services:

  # ==========================================================================
  # PostgreSQL 데이터베이스
  # ==========================================================================
  # - Django 데이터 저장용 (Video, Face, User 등)
  # - 운영 환경에서는 AWS RDS로 대체
  db:
    image: postgres:15-alpine
    container_name: faceblur_db

    # 환경 변수
    environment:
      POSTGRES_DB: faceblur_db           # 데이터베이스 이름
      POSTGRES_USER: postgres             # 사용자명
      POSTGRES_PASSWORD: postgres123      # 비밀번호 (운영환경에서 변경!)

    # 볼륨 (데이터 영구 저장)
    volumes:
      - postgres_data:/var/lib/postgresql/data

    # 포트 노출 (호스트:컨테이너)
    ports:
      - "5432:5432"

    # 헬스체크 (서비스가 정상 작동하는지 확인)
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

    # 네트워크
    networks:
      - faceblur_network

  # ==========================================================================
  # Redis 캐시 & 메시지 브로커
  # ==========================================================================
  # - Django 캐시로 사용 (API 응답 캐싱)
  # - Celery 메시지 브로커로 사용 (작업 큐)
  # - 세션 저장소로 사용
  # - 운영 환경에서는 AWS ElastiCache로 대체
  redis:
    image: redis:7-alpine
    container_name: faceblur_redis

    # 명령어 옵션
    command: redis-server --appendonly yes

    # 볼륨 (데이터 영구 저장)
    volumes:
      - redis_data:/data

    # 포트 노출
    ports:
      - "6379:6379"

    # 헬스체크
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - faceblur_network

  # ==========================================================================
  # Django 웹 서버
  # ==========================================================================
  # - 사용자 관리, 웹 UI, API 엔드포인트 제공
  # - Gunicorn WSGI 서버로 실행
  django:
    # Dockerfile.django 사용 (아래에서 생성)
    build:
      context: .
      dockerfile: Dockerfile.django

    container_name: faceblur_django

    # 시작 명령어
    # - 마이그레이션 실행
    # - Static 파일 수집
    # - Gunicorn으로 Django 실행 (4개 워커)
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             gunicorn face_blur_web.wsgi:application --bind 0.0.0.0:8000 --workers 4 --reload"

    # 볼륨 (코드 동기화 - 개발 중 코드 변경 시 자동 반영)
    volumes:
      - .:/app                                    # 현재 디렉토리를 /app에 마운트
      - static_volume:/app/staticfiles            # Static 파일
      - media_volume:/app/media                   # 업로드된 미디어 파일
      - ./models/yolov11s-face.pt:/app/models/yolov11s-face.pt:ro  # YOLO 모델 파일 (읽기 전용)

    # 포트 노출
    ports:
      - "8000:8000"

    # GPU 지원 (NVIDIA Docker 필요)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    # 환경 변수
    environment:
      - DEBUG=True
      - SECRET_KEY=django-insecure-dev-key-change-in-production
      - ALLOWED_HOSTS=localhost,127.0.0.1

      # 데이터베이스 연결
      - DB_ENGINE=django.db.backends.postgresql
      - DB_NAME=faceblur_db
      - DB_USER=postgres
      - DB_PASSWORD=postgres123
      - DB_HOST=db                                # Docker 네트워크에서 'db' 서비스명으로 접근
      - DB_PORT=5432

      # Redis 연결
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0

      # FastAPI 연결 (Phase 3에서 활성화)
      - FASTAPI_BASE_URL=http://fastapi:8001

      # S3 설정 (개발 환경에서는 로컬 파일 시스템 사용)
      - USE_S3=False
      # - AWS_ACCESS_KEY_ID=your-key
      # - AWS_SECRET_ACCESS_KEY=your-secret
      # - AWS_STORAGE_BUCKET_NAME=faceblur-videos
      # - AWS_REGION=ap-northeast-2

    # 의존성 (db와 redis가 먼저 시작되어야 함)
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

    # 네트워크
    networks:
      - faceblur_network

    # 재시작 정책
    restart: unless-stopped

  # ==========================================================================
  # Celery Worker (비동기 작업 처리)
  # ==========================================================================
  celery_worker:
    build:
      context: .
      dockerfile: Dockerfile.django

    container_name: faceblur_celery_worker

    # Celery 워커 실행
    # --max-tasks-per-child=1: 작업 1개 처리 후 워커 재시작 (메모리 누수 방지)
    # --prefetch-multiplier=1: 한 번에 1개 작업만 가져옴
    # --concurrency=1: 동시 실행 작업 수 (1개로 제한하여 메모리 안정성 확보)
    command: celery -A face_blur_web worker -l info --max-tasks-per-child=1 --prefetch-multiplier=1 --concurrency=1

    volumes:
      - .:/app
      - media_volume:/app/media
      - ./models/yolov11s-face.pt:/app/models/yolov11s-face.pt:ro  # YOLO 모델 파일

    # 메모리 제한 (Docker 레벨)
    mem_limit: 8g
    mem_reservation: 6g

    # GPU 지원 (얼굴 인식 AI 모델 실행용)
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 6G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    environment:
      - DB_ENGINE=django.db.backends.postgresql
      - DB_NAME=faceblur_db
      - DB_USER=postgres
      - DB_PASSWORD=postgres123
      - DB_HOST=db
      - DB_PORT=5432
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - FASTAPI_BASE_URL=http://fastapi:8001

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

    networks:
      - faceblur_network

    restart: unless-stopped

# ============================================================================
# 볼륨 정의 (데이터 영구 저장)
# ============================================================================
volumes:
  # PostgreSQL 데이터
  postgres_data:
    driver: local

  # Redis 데이터
  redis_data:
    driver: local

  # Django Static 파일 (CSS, JS, 이미지)
  static_volume:
    driver: local

  # 업로드된 미디어 파일 (영상, 썸네일)
  media_volume:
    driver: local

# ============================================================================
# 네트워크 정의
# ============================================================================
networks:
  faceblur_network:
    driver: bridge

# ============================================================================
# 사용 팁:
#
# 1. 첫 실행 시:
#    docker-compose up -d --build
#
# 2. 로그 확인:
#    docker-compose logs -f django
#
# 3. Django 쉘 접속:
#    docker-compose exec django python manage.py shell
#
# 4. 마이그레이션:
#    docker-compose exec django python manage.py makemigrations
#    docker-compose exec django python manage.py migrate
#
# 5. 슈퍼유저 생성:
#    docker-compose exec django python manage.py createsuperuser
#
# 6. 모든 서비스 중지:
#    docker-compose down
#
# 7. 볼륨까지 삭제 (데이터베이스 초기화):
#    docker-compose down -v
#
# ============================================================================
